# Data 분석
## 개발 환경
### IDE : Visual Studio Code, Google Colab
### 사용 기술
- 가상환경 venv
- Python 3.11.4
- Flask 3.0.0
- Pillow 10.1.0
- PyTorch 2.1.2
- Requests 2.31.0
- Yolov5 7.0.13
- Transformers 4.36.2
- RealESRGAN
- Scikit-learn 1.3.2

## 개발 내용

### 1. 데이터 수집
- 기업에 요청하여 데이터를 전달 받음
- 현장 사진(22.4GB)
- 차량 기록 파일(119MB)

### 2. 데이터 전처리
- 이미지 전처리
    - 전체 파일을 jpg 형식으로 변경
    - 전체 143,378장의 사진(22.4GB) 중 고철장 사진이 아닌 사진 제거
    - 고철장 사진 : 69,745장(11.4GB)
    - 고철장 사진 중 육안으로 봤을 때 번호판 숫자 4자리 인식 가능한 사진 무작위 선별 후 사진 이름을 번호판 숫자 4자리로 변경 : 9441장(1.54GB)
- 차량기록 파일 전처리
    - 불필요한 열 제거 후 열의 이름 추가
    - 등록날짜를 yyyy-mm-dd 형식으로 변경
    - 번호판이 ‘xxxxxx’인 행 제거, 중복인 번호판 제거

### 3. 사용한 모델
- 번호판 탐지 모델(keremberke/yolov5m-license-plate)
    - 번호판 탐지 후 좌표 4자리, 정확도 추출
    - 번호판 여러개 추출 가능
- 이미지 화질 개선 모델(Real-ESRGAN)
    - 번호판 추출 결과의 화질이 너무 떨어져 ocr인식이 힘듦
- OCR 인식 모델(microsoft/trocr-large-printed)
    - 사진에서 문자를 인식하기 위하여 ocr인식 진행
    - 한글 인식 불가
    - 사진이 크기가 작은 경우 easyocr에 비해 성능이 60% 좋음
- 객체 탐지 모델(facebook/detr-resnet-50)
    - 객체 탐지 후 좌표 4자리, 정확도, label 추출
    - 객체 여러개 추출 가능
- 피쳐 추출 모델(torchvision.models.resnet50)
    - 트럭이미지의 피쳐(길이가 2048인 리스트)를 추출
    - ocr인식을 실패하고 테스트 데이터가 아닌 차량 사진 최대 5개씩 선별하여 피쳐 추출(리스트 저장)
    - 코사인 유사도를 측정하여 가장 높게 나온 것 선택

### 4. 문제점
- 번호판 탐지 문제
	-  번호판 탐지 모델 결과가 아무것도 나오지 않음
- 화질 개선(Real-ESRGAN)모델 사용시 이미지 크기 문제
	-  이미지 크기가 작은 경우 에러 발생
- 번호판 오탐지 문제
	-  포크레인 뒤의 적혀있는 브랜드를 번호판으로 인식
	-  번호판이 아닌 것을 번호판으로 인식
	-  탐지하려는 번호판보다 정확도가 높게 나옴
- 트럭 오탐지 문제
	-  작업장의 포크레인을 트럭으로 인식
	-  탐지하려는 트럭보다 정확도가 높게 나옴

### 5. 해결방안
- 번호판 탐지 문제
	- 트럭탐지 모델로 먼저 트럭 이미지를 자른 후 번호판 탐지 모델 진행
- Real-ESRGAN 모델 사용시 이미지 크기 문제
    - 이미지 크기가 작을 때 비율에 맞게 크기를 키움
- 번호판 오탐지 문제
    - 포크레인 뒤의 브랜드를 탐지하는 경우 번호판 정확도가 높은 순으로 ocr모델을 진행시켜 결과가 ‘DO’, ‘NO’, ‘SO’, ‘RO’중 하나를 포함한다면 그 다음 정확도가 높은 것을 번호판으로 탐지하여 진행
    - 전혀 번호판이 아닌 것을 탐지하려는 번호판보다 정확도가 높게 탐지한 경우 해결 실패
- 트럭 오탐지 문제
	-  번호판 탐지 모델 결과의 좌표를 포함하는 객체만 트럭으로 탐지
    -  번호판 오탐지 + 트럭 오탐지일 경우 해결 실패

### 6. 평가
- 라벨링한 사진(9441장) 중 1422장 테스트 데이터로 사용
    - 번호판 탐지 -> 화질 개선 -> ocr인식 -> 결과 문자 제거
        - 정확도 71.9%(1023장 성공)
    - ocr인식 결과 숫자 4개를 인식 못한 경우 등록 번호판 DB 조회 후 결과를 전달 받아 피쳐 추출 후 코사인 유사도 측정
        - 정확도 82.5%(151장 추가  성공)

## 개발 일정
### 2023-12-18 ~ 2023-12-22 :
- 번호판 객체 추출 모델(keremberke/yolov5m-license-plate)
- OCR 모델 선정(숫자 4자리 중 최소 3개는 일치)
### 2023-12-26 : 
- 이미지 url을 전달 받아 번호판 추출(추출한 번호판 이미지 저장)
- 추출한 번호판 이미지 화질 개선
- 개선한 이미지로 숫자 추출
- 추출한 번호판 이미지(인코딩 필요)와 숫자 결과 JSON형식으로 전달
### 2023-12-27 :
- 날짜시간, 차량번호 csv파일 전처리 후 DB 저장
### 2023-12-28 : 
- 번호판이 크고 육안으로 숫자가 보이는 113장의 사진으로 모델 성능 측정(4자리 숫자 일치)
    - trocr : 93장 성공(82%)
    - easyocr : 86장 성공(76%)
    - 번호판 인식 실패 : 2장 (원래 번호판 인식 정확도 임계값을 0.7로 제한했었는데 임계값을 없앤 후 인식 성공)
- 번호판이 작고 육안으로 숫자가 보이는 90장의 사진으로 모델 성능 측정(4자리 숫자 일치, 번호판 인식 정확도 임계값 없이)
    - trocr : 75장 성공(83%)
    - easyocr : 24장 성공(26%)
### 2023-12-29 : 
- 번호판이 크고 육안으로 숫자가 보이는 137장의 사진으로 모델 성능 측정(4자리 숫자 일치, 번호판 인식 정확도 임계값 없이)
    - trocr : 120장 성공(87%)
- trocr train시키는 방법 찾기
### 2024-01-02 :
- 트럭 탐지 후 피쳐 뽑아내기
- 트럭 탐지 모델(facebook/detr-resnet-50)
    - 문제 : 트럭을 탐지하는데 작업장의 포크레인이 트럭으로 탐지되고 탐지하려는 트럭의 정확도보다 높게 나옴
    - 해결 : 번호판 추출 모델을 사용하여 번호판 좌표를 추출 후 좌표를 포함하는 트럭만 추출
    - 문제 : 현재 번호판 추출 모델은 가장 정확도가 높은 것만 추출 하는 데 번호판이 아닌 것(포크레인 뒤의 'DOOSAN')이 번호판 보다 정확도가 높게 나옴
    - 번호판이 작고 육안으로 숫자가 보이는 90장의 사진으로 모델 성능 측정
        - 위의 번호판 오인식 문제로 1개의 트럭 탐지 실패(98%)
### 2024-01-03 :
- 트럭 탐지 후 피쳐 뽑아내기(resnet18, resnet50, resnet152)
    - 번호판이 작고 육안으로 숫자가 보이는 90장의 사진으로 89장의 트럭 사진 추출
    - 89장의 트럭 피처 뽑아내서 리스트로 저장
- 피쳐 유사도 측정
    - 번호판이 크고 육안으로 숫자가 보이는 137장의 사진 중 트럭의 번호가 89장의 사진 중 일치하는 62장의 트럭 사진 추출
    - 62장의 트럭 사진 피쳐 뽑아내고 코사인 유사도를 이용하여 89개의 트럭 피쳐 중 가장 유사한 것 찾기
        - resnet18 : 62장의 사진 중 결과가 일치하는 것 10장(16%)
        - resnet50 : 62장의 사진 중 결과가 일치하는 것 16장(25%)
        - resnet152 : 62장의 사진 중 결과가 일치하는 것 18장(29%)
### 2024-01-04 :
- 코사인 유사도 이외에 다른 유사도 측정 방법 사용하기
    - 피쳐 뽑아내는 모델 resnet50 사용
    - Euclidean distance : 62장의 사진 중 결과가 일치하는 것 16장(25%)
    - Jaccard index : 62장의 사진 중 결과가 일치하는 것 2장(3%)
- 차원 줄이기
### 2024-01-05 :
- flask 서버에 truck detection 모델 추가
- 트럭의 배경을 지우고 트럭 머리만 최대한 남긴 후 피쳐 추출
    - 피쳐 뽑아내는 모델 resnet50 사용
    - Euclidean distance : 64장의 사진 중 결과가 일치하는 것 11장(17%)
    - 배경을 지우기 전보다 성능이 떨어짐
### 2024-01-08 :
- 피쳐를 제대로 뽑아내지 못하고 있었음
- 피쳐 뽑아내는 모델 vgg19로 변경(resnet보다 피쳐 뽑아내기 쉬움)
- 번호판이 크고 육안으로 숫자가 보이는 137장 중 ocr인식 실패한 17장으로 피쳐 유사도 측정
    - resnet50 : 6개 성공
    - vgg19 : 4개 성공
### 2024-01-09 :
- 총 69712(11.4GB)장의 사진 중 육안으로 번호판 숫자 4자리 인식이 가능한 사진 9534장 추출(파일 이름 : 숫자 4자리)
### 2024-01-10 :
- 9534장의 사진으로 번호판 추출, 이미지 개선, trocr 모델 돌린 후 성능 측정(1시간 18분 소요)
    - 7430장의 사진 성공(77.9%)
### 2024-01-11 :
- 9534장의 사진 중 사내운영 차량 삭제(90장) 9444장 남음
- 붉은색 번호판 차량 삭제(1장) 9443장 남음
- ocr인식 실패 원인 분석
    - 포크레인 뒤의 DOOSAN이라고 적힌 부분이 차량 번호판 보다 정확도가 크게 나온 경우 : ocr인식 결과에 'DO','NO','SO'가 포함된 경우 그 다음 정확도가 크게나온 번호판 인식으로 해결
    - 사진을 저장하고 다시 불러 올 때 사진데이터가 손상됨 : 사진을 저장, 불러오지 않고 그대로 모델에 넣으면서 진행
### 2024-01-12 :
- flask api 추가 구현
    - 백엔드에 ocr 결과를 리턴
    - ocr 결과가 1자리, 2자리, 3자리 숫자일 때 백엔드에서 DB 조회 후 결과 리스트로 전달 받음
    - 조회 결과 차량의 피쳐만 추출
    - 인풋 차량의 피쳐 추출
    - 유사도 측정 후 가장 유사한 차량의 번호 4자리 리턴 
### 2024-01-13 :
- 포크 레인 뒤의 'DOOSAN' 번호판으로 오인식 하는 경우 처리하는 코드 구현
### 2024-01-14 ~ 2024-01-18 :
- 코드 수정, 자료 정리, 발표 준비

## 참고자료
- 번호판 탐지 모델 https://huggingface.co/keremberke/yolov5m-license-plate
- 이미지 화질 개선 모델 https://github.com/sberbank-ai/Real-ESRGAN.git
- 객체 탐지 모델 https://huggingface.co/facebook/detr-resnet-50
- TrOCR 인식 모델 https://huggingface.co/microsoft/trocr-large-printed
- 피쳐 추출 모델 https://pytorch.org/vision/main/models/generated/torchvision.models.resnet50.html